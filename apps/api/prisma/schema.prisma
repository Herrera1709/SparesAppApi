// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Configuración del seed
// Ejecutar con: npm run prisma:seed

// Modelo de Usuario
model User {
  id                           String    @id @default(uuid())
  email                        String    @unique
  password                     String // Hash de la contraseña
  firstName                    String?
  lastName                     String?
  phone                        String?
  role                         UserRole  @default(USER)
  emailVerified                Boolean   @default(false) // Email verificado
  emailVerificationToken       String? // Token para verificación de email
  emailVerificationTokenExpiry DateTime? // Expiración del token de verificación
  resetToken                   String? // Token para reset de contraseña
  resetTokenExpiry             DateTime? // Expiración del token
  createdAt                    DateTime  @default(now())
  updatedAt                    DateTime  @updatedAt

  // Relaciones
  addresses                Address[]
  orders                   Order[]
  statusChanges            OrderStatusHistory[] @relation("OrderStatusChanges")
  wishlistItems            WishlistItem[]
  supportTickets           SupportTicket[]
  adminActions             AdminActionLog[]
  chatConversationsAsUser  ChatConversation[]   @relation("ChatUser")
  chatConversationsAsAdmin ChatConversation[]   @relation("ChatAdmin")
  chatMessages             ChatMessage[]
  inventoryMovements       InventoryMovement[]  @relation("InventoryMovementsPerformedBy")

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// Modelo de Dirección
model Address {
  id         String   @id @default(uuid())
  userId     String
  alias      String // Nombre/alias del domicilio (ej: "Casa", "Trabajo")
  street     String // Dirección exacta
  references String? // Referencias adicionales
  province   String // Provincia en Costa Rica
  canton     String // Cantón
  district   String // Distrito
  postalCode String?
  country    String   @default("Costa Rica")
  isDefault  Boolean  @default(false) // Domicilio principal
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relaciones
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@map("addresses")
}

// Modelo de Casillero Internacional
model Locker {
  id           String   @id @default(uuid())
  name         String // Nombre del casillero (ej: "Miami – USA")
  country      String // País del casillero
  city         String // Ciudad
  address      String // Dirección completa
  lockerCode   String // Código/formato del casillero
  instructions String // Instrucciones de uso (qué poner en Name, Address line 1, etc.)
  isActive     Boolean  @default(true) // Activo/desactivado
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  orders Order[]

  @@map("lockers")
}

// Modelo de Orden/Pedido
model Order {
  id                       String         @id @default(uuid())
  userId                   String
  addressId                String? // Domicilio de entrega
  lockerId                 String? // Casillero usado para este pedido
  externalLink             String // Link de Amazon/eBay/etc
  itemName                 String? // Nombre del artículo (opcional, se puede extraer después)
  quantity                 Int            @default(1) // Cantidad
  itemPrice                Decimal        @default(0) // Precio del artículo en USD
  shippingCost             Decimal        @default(0) // Costo de envío
  taxes                    Decimal        @default(0) // Impuestos
  serviceFee               Decimal        @default(0) // Tarifa de servicio
  totalPrice               Decimal // Precio total
  status                   OrderStatus    @default(CREATED)
  notes                    String? // Notas adicionales del usuario
  trackingNumber           String? // Número de tracking
  // Campos de cotización
  quotationExpiresAt       DateTime? // Validez de la cotización
  quotedAt                 DateTime? // Cuándo se generó la cotización
  acceptedAt               DateTime? // Cuándo el usuario aceptó
  // Campos de pago
  paymentStatus            PaymentStatus? // Estado del pago
  paymentMethod            PaymentMethod? // Método de pago usado
  // Campos de facturación
  invoiceNumber            String? // Número de factura
  invoicedAt               DateTime? // Fecha de facturación
  // Tiempos estimados
  estimatedDeliveryMinDays Int? // Días mínimos estimados
  estimatedDeliveryMaxDays Int? // Días máximos estimados
  // Campos de incidencias
  hasIssue                 Boolean        @default(false) // Marca si el pedido tiene problemas
  issueDescription         String? // Descripción de la incidencia
  tags                     String[]       @default([]) // Tags para organización (ej: ["URGENTE", "VIP"])
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt

  // Relaciones
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  address        Address?             @relation(fields: [addressId], references: [id], onDelete: SetNull)
  locker         Locker?              @relation(fields: [lockerId], references: [id], onDelete: SetNull)
  productId      String? // ID del producto relacionado (opcional)
  product        Product?             @relation(fields: [productId], references: [id], onDelete: SetNull)
  statusHistory  OrderStatusHistory[]
  payments       Payment[]
  supportTickets SupportTicket[]

  @@map("orders")
}

enum OrderStatus {
  CREATED // Pedido creado por el usuario
  REQUESTED // Solicitado (mantener compatibilidad)
  QUOTED // Cotizado
  PAYMENT_PENDING // Pago pendiente
  PAID // Pagado
  PURCHASED_FROM_STORE // Se compró en la tienda (Amazon/eBay/otra)
  ARRIVED_AT_FOREIGN_LOCKER // Llegó al casillero en el extranjero
  IN_TRANSIT_TO_CR // En tránsito hacia Costa Rica
  ARRIVED_IN_CR // Llegó a Costa Rica
  IN_CUSTOMS // En aduanas/migración
  RELEASED_FROM_CUSTOMS // Liberado de aduanas
  IN_NATIONAL_LOCKER // En casillero nacional/almacén local
  OUT_FOR_DELIVERY // En ruta hacia la casa del cliente
  DELIVERED // Entregado
  CANCELLED // Cancelado
}

// Historial de estados de una orden
model OrderStatusHistory {
  id        String      @id @default(uuid())
  orderId   String
  status    OrderStatus
  notes     String? // Notas/comentarios sobre el cambio de estado
  changedBy String? // ID del admin que hizo el cambio (opcional, puede ser null si es automático)
  createdAt DateTime    @default(now())

  // Relaciones
  order         Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  changedByUser User? @relation("OrderStatusChanges", fields: [changedBy], references: [id], onDelete: SetNull)

  @@map("order_status_history")
}

// Modelo de Pago
model Payment {
  id             String        @id @default(uuid())
  orderId        String
  method         PaymentMethod
  amount         Decimal // Monto del pago
  currency       String        @default("USD") // Moneda (USD, CRC)
  status         PaymentStatus @default(PENDING)
  // Campos específicos de SINPE
  sinpeCode      String? // Código que la app genera para que el usuario lo ponga en el detalle del SINPE
  sinpeReference String? // Referencia que el usuario o admin registra desde el comprobante
  // Campos para futuro pago con tarjeta
  cardToken      String? // Token de pasarela (nunca guardar tarjeta cruda)
  cardLast4      String? // Últimos 4 dígitos (solo lectura)
  cardBrand      String? // Visa, Mastercard, etc.
  // Metadata adicional
  metadata       Json? // Datos adicionales en formato JSON
  createdAt      DateTime      @default(now())
  confirmedAt    DateTime? // Cuándo se confirmó el pago
  failedAt       DateTime? // Cuándo falló el pago

  // Relaciones
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum PaymentMethod {
  SINPE
  CARD
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

// Modelo de Wishlist
model WishlistItem {
  id           String   @id @default(uuid())
  userId       String
  externalLink String // Link del producto
  title        String? // Título/nombre del producto
  notes        String? // Notas del usuario
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wishlist_items")
}

// Modelo de Ticket de Soporte
model SupportTicket {
  id          String         @id @default(uuid())
  orderId     String
  userId      String
  status      TicketStatus   @default(OPEN)
  category    TicketCategory
  title       String
  description String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relaciones
  order    Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages TicketMessage[]

  @@map("support_tickets")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum TicketCategory {
  SHIPPING
  BILLING
  PRODUCT
  OTHER
}

// Modelo de Mensajes de Ticket (opcional, para conversación)
model TicketMessage {
  id        String   @id @default(uuid())
  ticketId  String
  userId    String? // Usuario que envió el mensaje (null si es admin automático)
  isAdmin   Boolean  @default(false) // Si es mensaje de admin
  message   String
  createdAt DateTime @default(now())

  // Relaciones
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_messages")
}

// Modelo de Log de Acciones de Admin (Auditoría)
model AdminActionLog {
  id            String   @id @default(uuid())
  adminId       String
  entityType    String // "ORDER", "PAYMENT", "LOCKER", "TICKET", etc.
  entityId      String // ID de la entidad afectada
  action        String // "UPDATE_STATUS", "UPDATE_PRICES", "CONFIRM_PAYMENT", etc.
  previousValue Json? // Valor anterior (resumido)
  newValue      Json? // Valor nuevo (resumido)
  notes         String? // Notas adicionales
  createdAt     DateTime @default(now())

  // Relaciones
  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_action_logs")
}

// Modelo de Conversación de Chat
model ChatConversation {
  id             String     @id @default(uuid())
  userId         String? // Usuario registrado (null si es invitado)
  adminId        String? // Admin asignado a la conversación
  guestName      String? // Nombre del invitado (si no está registrado)
  guestEmail     String? // Email del invitado (si no está registrado)
  guestPhone     String? // Teléfono del invitado (si no está registrado)
  subject        String? // Tema/asunto de la conversación
  status         ChatStatus @default(OPEN)
  lastMessageAt  DateTime? // Último mensaje enviado
  lastActivityAt DateTime? // Última actividad (para expiración)
  expiresAt      DateTime? // Fecha de expiración (5 min después de inactividad)
  closedAt       DateTime? // Fecha de cierre/expiración
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relaciones
  user     User?         @relation("ChatUser", fields: [userId], references: [id], onDelete: Cascade)
  admin    User?         @relation("ChatAdmin", fields: [adminId], references: [id], onDelete: SetNull)
  messages ChatMessage[]

  @@map("chat_conversations")
}

enum ChatStatus {
  OPEN
  ASSIGNED
  CLOSED
}

// Modelo de Mensaje de Chat
model ChatMessage {
  id             String    @id @default(uuid())
  conversationId String
  senderId       String? // ID del usuario/admin que envió (null si es sistema)
  isFromAdmin    Boolean   @default(false)
  isSystem       Boolean   @default(false) // Mensaje del sistema
  content        String
  readAt         DateTime? // Cuándo fue leído
  createdAt      DateTime  @default(now())

  // Relaciones
  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?            @relation(fields: [senderId], references: [id], onDelete: SetNull)

  @@map("chat_messages")
}

// Modelo de Configuración de Horario de Asistencia
model ChatSupportSchedule {
  id        String   @id @default(uuid())
  dayOfWeek Int // 0 = Domingo, 1 = Lunes, ..., 6 = Sábado
  isActive  Boolean  @default(true)
  startTime String // Formato HH:mm (ej: "09:00")
  endTime   String // Formato HH:mm (ej: "17:00")
  timezone  String   @default("America/Costa_Rica")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dayOfWeek])
  @@map("chat_support_schedules")
}

// Modelo de Configuración General del Chat
model ChatSettings {
  id          String   @id @default(uuid())
  key         String   @unique // Clave única de la configuración
  value       String // Valor de la configuración
  description String? // Descripción de la configuración
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("chat_settings")
}

// Modelo de Producto/Repuesto
model Product {
  id          String   @id @default(uuid())
  sku         String   @unique // Código SKU único
  partNumber  String? // Número de parte del fabricante
  oemNumber   String? // Número OEM (Original Equipment Manufacturer)
  name        String // Nombre del producto/repuesto
  description String? // Descripción del producto
  category    String? // Categoría del producto (frenos, suspensión, motor, etc.)
  brand       String? // Marca del repuesto (Brembo, NGK, etc.)
  price       Decimal  @default(0) // Precio unitario en USD
  cost        Decimal  @default(0) // Costo unitario en USD
  imageUrl    String? // URL de la imagen
  images      String[] @default([]) // Múltiples imágenes
  barcode     String? // Código de barras
  isActive    Boolean  @default(true) // Producto activo/inactivo
  isUniversal Boolean  @default(false) // Repuesto universal (no requiere vehículo específico)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  inventoryItems Inventory[]
  movements      InventoryMovement[]
  orders         Order[]
  fitments       PartFitment[] // Compatibilidad con vehículos

  @@index([category])
  @@index([brand])
  @@index([sku])
  @@index([partNumber])
  @@index([oemNumber])
  @@map("products")
}

// Modelo de Inventario
model Inventory {
  id               String    @id @default(uuid())
  productId        String
  quantity         Int       @default(0) // Cantidad actual en stock
  minQuantity      Int       @default(0) // Cantidad mínima (punto de reorden)
  maxQuantity      Int? // Cantidad máxima
  location         String? // Ubicación en almacén (ej: "A-1-2", "B-3-4")
  warehouse        String? // Almacén o bodega
  reservedQuantity Int       @default(0) // Cantidad reservada (en órdenes pendientes)
  lastRestockedAt  DateTime? // Última vez que se reabasteció
  notes            String? // Notas adicionales
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relaciones
  product   Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  movements InventoryMovement[]

  @@unique([productId, location, warehouse])
  @@map("inventory")
}

// Modelo de Movimientos de Inventario
model InventoryMovement {
  id            String                @id @default(uuid())
  inventoryId   String
  productId     String
  type          InventoryMovementType
  quantity      Int // Cantidad (positiva para entradas, negativa para salidas)
  reason        String? // Razón del movimiento
  referenceId   String? // ID de referencia (ej: orderId para entregas)
  referenceType String? // Tipo de referencia (ORDER, ADJUSTMENT, RESTOCK, etc.)
  performedBy   String? // ID del usuario/admin que realizó el movimiento
  notes         String? // Notas adicionales
  createdAt     DateTime              @default(now())

  // Relaciones
  inventory       Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  performedByUser User?     @relation("InventoryMovementsPerformedBy", fields: [performedBy], references: [id], onDelete: SetNull)

  @@map("inventory_movements")
}

enum InventoryMovementType {
  IN // Entrada (compra, reabastecimiento, ajuste positivo)
  OUT // Salida (venta, entrega, ajuste negativo)
  ADJUSTMENT // Ajuste manual
  TRANSFER // Transferencia entre ubicaciones
  RETURN // Devolución
  DAMAGED // Producto dañado
  EXPIRED // Producto vencido
}

// ============================================
// SISTEMA DE COMPATIBILIDAD DE REPUESTOS
// ============================================

// Modelo de Vehículo (Marca y Modelo)
model Vehicle {
  id          String   @id @default(uuid())
  make        String // Marca (Toyota, Honda, Ford, etc.)
  model       String // Modelo (Corolla, Civic, F-150, etc.)
  yearFrom    Int? // Año inicial del modelo
  yearTo      Int? // Año final del modelo
  bodyType    String? // Tipo de carrocería (Sedan, SUV, Pickup, etc.)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  variants VehicleVariant[]
  fitments PartFitment[]

  @@unique([make, model, yearFrom, yearTo])
  @@index([make])
  @@index([model])
  @@index([make, model])
  @@map("vehicles")
}

// Modelo de Variante de Vehículo (Versión, Motor, Transmisión)
model VehicleVariant {
  id           String   @id @default(uuid())
  vehicleId    String
  trim         String? // Versión/Trim (LX, EX, SR, etc.)
  engine       String? // Motor (1.8, 2.0, 2AR-FE, etc.)
  transmission String? // Transmisión (Manual, Automática, CVT, etc.)
  driveType    String? // Tracción (FWD, RWD, AWD, 4WD)
  notes        String? // Notas adicionales
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  fitments PartFitment[]

  @@index([vehicleId])
  @@map("vehicle_variants")
}

// Modelo de Compatibilidad (Repuesto ↔ Vehículo)
model PartFitment {
  id              String   @id @default(uuid())
  productId       String
  vehicleId       String? // Vehículo base (si no requiere variante específica)
  vehicleVariantId String? // Variante específica (si aplica)
  yearFrom        Int? // Año inicial de compatibilidad
  yearTo          Int? // Año final de compatibilidad
  position        String? // Posición (delantero, trasero, izquierdo, derecho, etc.)
  side            String? // Lado (izquierdo, derecho, ambos)
  notes           String? // Notas adicionales de compatibilidad
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  vehicle        Vehicle?        @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleVariant VehicleVariant? @relation(fields: [vehicleVariantId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([vehicleId])
  @@index([vehicleVariantId])
  @@index([productId, vehicleId])
  @@index([productId, vehicleVariantId])
  @@map("part_fitments")
}
